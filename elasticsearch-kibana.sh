#!/usr/bin/env bash

## Linode/SSH Security Settings
#<UDF name="username" label="The limited sudo user to be created for the Linode" default="">
#<UDF name="password" label="The password for the limited sudo user" example="s3cure_p4ssw0rd" default="">
#<UDF name="pubkey" label="The SSH Public Key that will be used to access the Linode" default="">
#<UDF name="disable_root" label="Disable password authentication over SSH?" oneOf="Yes,No" default="No">
#<UDF name="elasticsearch_password" label="The password for the 'elastic' user of Elasticsearch and Kibana">
#<UDF name="ds2_username" label="The user to post data from Akamai DataStream 2" example="Example: ds2user">
#<UDF name="ds2_password" label="The password to post data from Akamai DataStream 2">

## Enable logging
set -o pipefail
exec > >(tee /dev/ttyS0 /var/log/stackscript.log) 2>&1

## Import the Bash StackScript Library
source <ssinclude StackScriptID=1>

## Import the OCA Helper Functions
source <ssinclude StackScriptID=401712>

## Run initial configuration tasks (DNS/SSH stuff, etc...)
source <ssinclude StackScriptID=666912>

## Update system & set hostname & basic security
set_hostname
apt_setup_update
ufw_install
ufw allow 5601/tcp
ufw allow 9200/tcp

## Time sync configuration
sed -i "s/^#NTP=/NTP=pool.ntp.org/" /etc/systemd/timesyncd.conf
systemctl restart systemd-timesyncd

# Install Elasticsearch
wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | gpg --dearmor -o /usr/share/keyrings/elasticsearch-keyring.gpg
apt-get install apt-transport-https
echo "deb [signed-by=/usr/share/keyrings/elasticsearch-keyring.gpg] https://artifacts.elastic.co/packages/8.x/apt stable main" | tee /etc/apt/sources.list.d/elastic-8.x.list
apt-get update
apt-get install elasticsearch
sed -z -i -e "s/xpack\.security\.http\.ssl:\n  enabled: true/xpack.security.http.ssl:\n  enabled: false/" /etc/elasticsearch/elasticsearch.yml

mkdir /etc/systemd/system/elasticsearch.service.d
echo -e "[Service]\nTimeoutStartSec=180" | sudo tee /etc/systemd/system/elasticsearch.service.d/startup-timeout.conf
systemctl daemon-reload
systemctl enable elasticsearch.service
systemctl start elasticsearch.service

# Create a new index for Elasticsearch
ELASTIC_ADMIN_PASSWORD=`/usr/share/elasticsearch/bin/elasticsearch-reset-password -b -u elastic | grep 'New value' | sed 's/New value:\s*//'`
curl --cacert /etc/elasticsearch/certs/http_ca.crt -u elastic:$ELASTIC_ADMIN_PASSWORD -X PUT "http://localhost:9200/datastream2?pretty" -H 'Content-Type: application/json' -d '{ "mappings": { "properties": { "UA": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 512 } } }, "accLang": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "billingRegion": { "type": "byte", "ignore_malformed": true, "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "bytes": { "type": "long", "ignore_malformed": true, "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "cacheStatus": { "type": "byte", "ignore_malformed": true, "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "city": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "cliIP": { "type": "ip", "ignore_malformed": true, "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "cookie": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 4096 } } }, "country": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "cp": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "customField": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "dnsLookupTimeMSec": { "type": "integer", "ignore_malformed": true, "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "edgeIP": { "type": "ip", "ignore_malformed": true, "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "errorCode": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "ewExecutionInfo": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 1024 } } }, "ewUsageInfo": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 1024 } } }, "maxAgeSec": { "type": "integer", "ignore_malformed": true, "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "objSize": { "type": "long", "ignore_malformed": true, "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "overheadBytes": { "type": "long", "ignore_malformed": true, "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "proto": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "queryStr": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 512 } } }, "range": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "referer": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 512 } } }, "reqEndTimeMSec": { "type": "integer", "ignore_malformed": true, "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "reqHost": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "reqId": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "reqMethod": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "reqPath": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 1024 } } }, "reqPort": { "type": "short", "ignore_malformed": true, "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "reqTimeSec": { "type": "date", "format": "strict_date_optional_time||epoch_second", "ignore_malformed": true, "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "rspContentLen": { "type": "long", "ignore_malformed": true, "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "rspContentType": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "securityRules": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "serverCountry": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "state": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "statusCode": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "streamId": { "type": "short", "ignore_malformed": true, "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "tlsOverheadTimeMSec": { "type": "integer", "ignore_malformed": true, "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "tlsVersion": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "totalBytes": { "type": "long", "ignore_malformed": true, "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "transferTimeMSec": { "type": "integer", "ignore_malformed": true, "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "turnAroundTimeMSec": { "type": "integer", "ignore_malformed": true, "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "uncompressedSize": { "type": "long", "ignore_malformed": true, "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "version": { "type": "byte", "ignore_malformed": true, "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } }, "xForwardedFor": { "type": "text", "fields": { "keyword": { "type": "keyword", "ignore_above": 256 } } } } } }'

# Install Kibana
ELASTIC_KIBANA_PASSWORD=`/usr/share/elasticsearch/bin/elasticsearch-reset-password -b -u kibana_system | grep 'New value' | sed 's/New value:\s*//'`

apt-get install kibana
sed -i -e "s/#server\.host:.*/server.host: \"0.0.0.0\"/" /etc/kibana/kibana.yml
sed -i -e "s/#elasticsearch\.username:.*/elasticsearch.username: \"kibana_system\"/" /etc/kibana/kibana.yml
sed -i -e "s/#elasticsearch\.password:.*/elasticsearch.password: \"$ELASTIC_KIBANA_PASSWORD\"/" /etc/kibana/kibana.yml

systemctl daemon-reload
systemctl enable kibana.service
systemctl start kibana.service

# Create an Elasticsearch user to push logs from DataStream 2
curl --cacert /etc/elasticsearch/certs/http_ca.crt -u elastic:$ELASTIC_ADMIN_PASSWORD -X POST "http://localhost:9200/_security/role/ds2_writer" -H 'Content-Type: application/json' -d '{ "indices": [ { "names": "datastream2", "privileges": ["write"] } ] }'
curl --cacert /etc/elasticsearch/certs/http_ca.crt -u elastic:$ELASTIC_ADMIN_PASSWORD -X POST "http://localhost:9200/_security/user/$DS2_USERNAME" -H 'Content-Type: application/json' -d "{ \"password\" : \"$DS2_PASSWORD\", \"roles\": [\"ds2_writer\"] }"

# Setup Kibana objects
cat > /tmp/kibana.ndjson <<EOF
{"attributes":{"fieldAttrs":"{}","fieldFormatMap":"{\"cacheStatus\":{\"id\":\"static_lookup\",\"params\":{\"parsedUrl\":{\"origin\":\"\",\"pathname\":\"\",\"basePath\":\"\"},\"lookupEntries\":[{\"key\":\"0\",\"value\":\"Miss\"},{\"key\":\"1\",\"value\":\"Hit\"}],\"unknownKeyValue\":null}},\"cacheStatus.keyword\":{\"id\":\"static_lookup\",\"params\":{\"parsedUrl\":{\"origin\":\"\",\"pathname\":\"\",\"basePath\":\"\"},\"lookupEntries\":[{\"key\":\"0\",\"value\":\"Miss\"},{\"key\":\"1\",\"value\":\"Hit\"}],\"unknownKeyValue\":null}},\"referer\":{\"id\":\"url\",\"params\":{\"parsedUrl\":{\"origin\":\"\",\"pathname\":\"\",\"basePath\":\"\"},\"type\":\"a\",\"urlTemplate\":null,\"labelTemplate\":null,\"width\":null,\"height\":null,\"openLinkInCurrentTab\":false}},\"referer.keyword\":{\"id\":\"url\",\"params\":{}},\"UA\":{\"id\":\"string\",\"params\":{\"parsedUrl\":{\"origin\":\"http://139.162.72.68:5601\",\"pathname\":\"/app/home\",\"basePath\":\"\"},\"transform\":\"urlparam\"}},\"UA.keyword\":{\"id\":\"string\",\"params\":{\"parsedUrl\":{\"origin\":\"http://139.162.72.68:5601\",\"pathname\":\"/app/home\",\"basePath\":\"\"},\"transform\":\"urlparam\"}}}","fields":"[]","name":"datastream2","runtimeFieldMap":"{}","sourceFilters":"[]","timeFieldName":"reqTimeSec","title":"datastream2","typeMeta":"{}"},"coreMigrationVersion":"8.4.1","id":"0bc2af01-c4ee-409b-b44f-9c547251aac7","migrationVersion":{"index-pattern":"8.0.0"},"references":[],"type":"index-pattern","updated_at":"2022-09-18T09:13:02.286Z","version":"WzQyNCwxXQ=="}
{"attributes":{"description":"","state":{"datasourceStates":{"indexpattern":{"layers":{"ae032f63-24fd-41be-a139-654fb5896504":{"columnOrder":["2348a13e-85a4-4a5c-acf5-baf3669bcb11","f75b544d-7442-4f06-9ca7-6c4c4e5e5ef2"],"columns":{"2348a13e-85a4-4a5c-acf5-baf3669bcb11":{"dataType":"date","isBucketed":true,"label":"reqTimeSec","operationType":"date_histogram","params":{"dropPartials":false,"includeEmptyRows":true,"interval":"auto"},"scale":"interval","sourceField":"reqTimeSec"},"f75b544d-7442-4f06-9ca7-6c4c4e5e5ef2":{"customLabel":true,"dataType":"number","isBucketed":false,"label":"Hit","operationType":"count","params":{"emptyAsNull":true},"scale":"ratio","sourceField":"___records___"}},"incompleteColumns":{}}}}},"filters":[],"query":{"language":"kuery","query":""},"visualization":{"axisTitlesVisibilitySettings":{"x":true,"yLeft":true,"yRight":true},"fittingFunction":"None","gridlinesVisibilitySettings":{"x":true,"yLeft":true,"yRight":true},"labelsOrientation":{"x":0,"yLeft":0,"yRight":0},"layers":[{"accessors":["f75b544d-7442-4f06-9ca7-6c4c4e5e5ef2"],"layerId":"ae032f63-24fd-41be-a139-654fb5896504","layerType":"data","position":"top","seriesType":"bar_stacked","showGridlines":false,"xAccessor":"2348a13e-85a4-4a5c-acf5-baf3669bcb11"}],"legend":{"isVisible":true,"position":"right"},"preferredSeriesType":"bar_stacked","tickLabelsVisibilitySettings":{"x":true,"yLeft":true,"yRight":true},"valueLabels":"hide"}},"title":"Edge Hit","visualizationType":"lnsXY"},"coreMigrationVersion":"8.4.1","id":"21d7ed80-36f5-11ed-9843-4d8cf291ba88","migrationVersion":{"lens":"8.3.0"},"references":[{"id":"0bc2af01-c4ee-409b-b44f-9c547251aac7","name":"indexpattern-datasource-layer-ae032f63-24fd-41be-a139-654fb5896504","type":"index-pattern"}],"type":"lens","updated_at":"2022-09-18T09:03:46.325Z","version":"WzEzMCwxXQ=="}
{"attributes":{"description":"","state":{"datasourceStates":{"indexpattern":{"layers":{"c88ee462-a76b-475d-9518-449a039727a3":{"columnOrder":["48b7ce66-eda2-410f-b7c4-63fc6825d998","45de0327-163e-4bbd-9d1e-13544cd92be5","45de0327-163e-4bbd-9d1e-13544cd92be5X0","45de0327-163e-4bbd-9d1e-13544cd92be5X1"],"columns":{"45de0327-163e-4bbd-9d1e-13544cd92be5":{"customLabel":true,"dataType":"number","isBucketed":false,"label":"Edge Bytes (GB)","operationType":"formula","params":{"formula":"sum(bytes) / 1000 / 1000 / 1000","isFormulaBroken":false},"references":["45de0327-163e-4bbd-9d1e-13544cd92be5X1"],"scale":"ratio"},"45de0327-163e-4bbd-9d1e-13544cd92be5X0":{"customLabel":true,"dataType":"number","isBucketed":false,"label":"Part of Edge Bytes (GB)","operationType":"sum","params":{"emptyAsNull":false},"scale":"ratio","sourceField":"bytes"},"45de0327-163e-4bbd-9d1e-13544cd92be5X1":{"customLabel":true,"dataType":"number","isBucketed":false,"label":"Part of Edge Bytes (GB)","operationType":"math","params":{"tinymathAst":{"args":[{"args":[{"args":["45de0327-163e-4bbd-9d1e-13544cd92be5X0",1000],"name":"divide","type":"function"},1000],"name":"divide","type":"function"},1000],"location":{"max":31,"min":0},"name":"divide","text":"sum(bytes) / 1000 / 1000 / 1000","type":"function"}},"references":["45de0327-163e-4bbd-9d1e-13544cd92be5X0"],"scale":"ratio"},"48b7ce66-eda2-410f-b7c4-63fc6825d998":{"dataType":"date","isBucketed":true,"label":"reqTimeSec","operationType":"date_histogram","params":{"dropPartials":false,"includeEmptyRows":true,"interval":"auto"},"scale":"interval","sourceField":"reqTimeSec"}},"incompleteColumns":{}}}}},"filters":[],"query":{"language":"kuery","query":""},"visualization":{"axisTitlesVisibilitySettings":{"x":true,"yLeft":true,"yRight":true},"fittingFunction":"None","gridlinesVisibilitySettings":{"x":true,"yLeft":true,"yRight":true},"labelsOrientation":{"x":0,"yLeft":0,"yRight":0},"layers":[{"accessors":["45de0327-163e-4bbd-9d1e-13544cd92be5"],"layerId":"c88ee462-a76b-475d-9518-449a039727a3","layerType":"data","position":"top","seriesType":"bar","showGridlines":false,"xAccessor":"48b7ce66-eda2-410f-b7c4-63fc6825d998"}],"legend":{"isVisible":true,"position":"right"},"preferredSeriesType":"bar","tickLabelsVisibilitySettings":{"x":true,"yLeft":true,"yRight":true},"valueLabels":"hide"}},"title":"Edge Bytes (GB)","visualizationType":"lnsXY"},"coreMigrationVersion":"8.4.1","id":"a3372db0-36e0-11ed-9843-4d8cf291ba88","migrationVersion":{"lens":"8.3.0"},"references":[{"id":"0bc2af01-c4ee-409b-b44f-9c547251aac7","name":"indexpattern-datasource-layer-c88ee462-a76b-475d-9518-449a039727a3","type":"index-pattern"}],"type":"lens","updated_at":"2022-09-18T09:03:46.325Z","version":"WzEzMSwxXQ=="}
{"attributes":{"description":"","state":{"datasourceStates":{"indexpattern":{"layers":{"64a96f2b-118e-49aa-a81b-73e712e58dd2":{"columnOrder":["2aad2ecc-29a5-4a90-bc07-2b055e37f646","e374aa2e-9061-4bd9-80cf-da8af8ffe8c8"],"columns":{"2aad2ecc-29a5-4a90-bc07-2b055e37f646":{"dataType":"string","isBucketed":true,"label":"Top 5 values of cacheStatus.keyword","operationType":"terms","params":{"missingBucket":false,"orderBy":{"columnId":"e374aa2e-9061-4bd9-80cf-da8af8ffe8c8","type":"column"},"orderDirection":"desc","otherBucket":true,"parentFormat":{"id":"terms"},"size":5},"scale":"ordinal","sourceField":"cacheStatus.keyword"},"e374aa2e-9061-4bd9-80cf-da8af8ffe8c8":{"dataType":"number","isBucketed":false,"label":"Count of records","operationType":"count","params":{"emptyAsNull":true},"scale":"ratio","sourceField":"___records___"}},"incompleteColumns":{}}}}},"filters":[],"query":{"language":"kuery","query":""},"visualization":{"layers":[{"categoryDisplay":"default","groups":["2aad2ecc-29a5-4a90-bc07-2b055e37f646"],"layerId":"64a96f2b-118e-49aa-a81b-73e712e58dd2","layerType":"data","legendDisplay":"default","metric":"e374aa2e-9061-4bd9-80cf-da8af8ffe8c8","nestedLegend":false,"numberDisplay":"percent"}],"shape":"donut"}},"title":"Cache Hit Ratio","visualizationType":"lnsPie"},"coreMigrationVersion":"8.4.1","id":"48200dd0-36ee-11ed-9843-4d8cf291ba88","migrationVersion":{"lens":"8.3.0"},"references":[{"id":"0bc2af01-c4ee-409b-b44f-9c547251aac7","name":"indexpattern-datasource-layer-64a96f2b-118e-49aa-a81b-73e712e58dd2","type":"index-pattern"}],"type":"lens","updated_at":"2022-09-18T09:03:46.325Z","version":"WzEzMiwxXQ=="}
{"attributes":{"description":"","state":{"datasourceStates":{"indexpattern":{"layers":{"c749bdf4-4f60-450c-a225-ec251e858c3c":{"columnOrder":["a6438855-c0b3-4c05-823d-aa25ca41c0f8","9e3c964b-b1c4-4e7e-942f-701ec6e2ccd7"],"columns":{"9e3c964b-b1c4-4e7e-942f-701ec6e2ccd7":{"dataType":"number","isBucketed":false,"label":"Count of records","operationType":"count","params":{"emptyAsNull":true},"scale":"ratio","sourceField":"___records___"},"a6438855-c0b3-4c05-823d-aa25ca41c0f8":{"dataType":"string","isBucketed":true,"label":"Top 300 values of country.keyword","operationType":"terms","params":{"missingBucket":false,"orderBy":{"columnId":"9e3c964b-b1c4-4e7e-942f-701ec6e2ccd7","type":"column"},"orderDirection":"desc","otherBucket":true,"parentFormat":{"id":"terms"},"size":300},"scale":"ordinal","sourceField":"country.keyword"}},"incompleteColumns":{}}}}},"filters":[],"query":{"language":"kuery","query":""},"visualization":{"layerId":"c749bdf4-4f60-450c-a225-ec251e858c3c","regionAccessor":"a6438855-c0b3-4c05-823d-aa25ca41c0f8","valueAccessor":"9e3c964b-b1c4-4e7e-942f-701ec6e2ccd7"}},"title":"Country/Region","visualizationType":"lnsChoropleth"},"coreMigrationVersion":"8.4.1","id":"cfd91230-36df-11ed-9843-4d8cf291ba88","migrationVersion":{"lens":"8.3.0"},"references":[{"id":"0bc2af01-c4ee-409b-b44f-9c547251aac7","name":"indexpattern-datasource-layer-c749bdf4-4f60-450c-a225-ec251e858c3c","type":"index-pattern"}],"type":"lens","updated_at":"2022-09-18T09:03:46.325Z","version":"WzEzMywxXQ=="}
{"attributes":{"description":"","state":{"datasourceStates":{"indexpattern":{"layers":{"581c0015-6a7e-4658-8c7a-039d56621419":{"columnOrder":["a9346422-1ca9-4a82-bd77-354348c0d8b9","e5212a7f-5471-4ea2-9fab-0ed6b664f5b6"],"columns":{"a9346422-1ca9-4a82-bd77-354348c0d8b9":{"dataType":"string","isBucketed":true,"label":"Top 50 values of statusCode.keyword","operationType":"terms","params":{"missingBucket":false,"orderBy":{"columnId":"e5212a7f-5471-4ea2-9fab-0ed6b664f5b6","type":"column"},"orderDirection":"desc","otherBucket":true,"parentFormat":{"id":"terms"},"size":50},"scale":"ordinal","sourceField":"statusCode.keyword"},"e5212a7f-5471-4ea2-9fab-0ed6b664f5b6":{"dataType":"number","isBucketed":false,"label":"Count of records","operationType":"count","params":{"emptyAsNull":true},"scale":"ratio","sourceField":"___records___"}},"incompleteColumns":{}}}}},"filters":[],"query":{"language":"kuery","query":""},"visualization":{"layers":[{"categoryDisplay":"default","groups":["a9346422-1ca9-4a82-bd77-354348c0d8b9"],"layerId":"581c0015-6a7e-4658-8c7a-039d56621419","layerType":"data","legendDisplay":"default","metric":"e5212a7f-5471-4ea2-9fab-0ed6b664f5b6","nestedLegend":false,"numberDisplay":"percent"}],"shape":"donut"}},"title":"Status Code","visualizationType":"lnsPie"},"coreMigrationVersion":"8.4.1","id":"7e7c1c60-36ef-11ed-9843-4d8cf291ba88","migrationVersion":{"lens":"8.3.0"},"references":[{"id":"0bc2af01-c4ee-409b-b44f-9c547251aac7","name":"indexpattern-datasource-layer-581c0015-6a7e-4658-8c7a-039d56621419","type":"index-pattern"}],"type":"lens","updated_at":"2022-09-18T09:03:46.325Z","version":"WzEzNCwxXQ=="}
{"attributes":{"description":"","state":{"datasourceStates":{"indexpattern":{"layers":{"abb4a8ed-2cd6-432a-bfcc-c241ff556e77":{"columnOrder":["0b01655f-5f9f-4e5a-b6a8-2ac0b8c4b5c2","1ededbb7-b272-4899-9cb6-2eda320a24ea"],"columns":{"0b01655f-5f9f-4e5a-b6a8-2ac0b8c4b5c2":{"dataType":"string","isBucketed":true,"label":"Top 5 values of reqMethod.keyword","operationType":"terms","params":{"missingBucket":false,"orderBy":{"columnId":"1ededbb7-b272-4899-9cb6-2eda320a24ea","type":"column"},"orderDirection":"desc","otherBucket":true,"parentFormat":{"id":"terms"},"size":5},"scale":"ordinal","sourceField":"reqMethod.keyword"},"1ededbb7-b272-4899-9cb6-2eda320a24ea":{"dataType":"number","isBucketed":false,"label":"Count of records","operationType":"count","params":{"emptyAsNull":true},"scale":"ratio","sourceField":"___records___"}},"incompleteColumns":{}}}}},"filters":[],"query":{"language":"kuery","query":""},"visualization":{"layers":[{"categoryDisplay":"default","groups":["0b01655f-5f9f-4e5a-b6a8-2ac0b8c4b5c2"],"layerId":"abb4a8ed-2cd6-432a-bfcc-c241ff556e77","layerType":"data","legendDisplay":"default","metric":"1ededbb7-b272-4899-9cb6-2eda320a24ea","nestedLegend":false,"numberDisplay":"percent"}],"shape":"donut"}},"title":"Request Method","visualizationType":"lnsPie"},"coreMigrationVersion":"8.4.1","id":"54b316e0-36ef-11ed-9843-4d8cf291ba88","migrationVersion":{"lens":"8.3.0"},"references":[{"id":"0bc2af01-c4ee-409b-b44f-9c547251aac7","name":"indexpattern-datasource-layer-abb4a8ed-2cd6-432a-bfcc-c241ff556e77","type":"index-pattern"}],"type":"lens","updated_at":"2022-09-18T09:03:46.325Z","version":"WzEzNSwxXQ=="}
{"attributes":{"description":"","state":{"datasourceStates":{"indexpattern":{"layers":{"513e4cd3-c4f3-4337-a7eb-fb2fb6837fbd":{"columnOrder":["c57f7505-5350-42ca-960b-01935d4a1b2f","fdcce67a-0b5e-4959-a90d-5aaf923f440c"],"columns":{"c57f7505-5350-42ca-960b-01935d4a1b2f":{"dataType":"string","isBucketed":true,"label":"Top 5 values of proto.keyword","operationType":"terms","params":{"missingBucket":false,"orderBy":{"columnId":"fdcce67a-0b5e-4959-a90d-5aaf923f440c","type":"column"},"orderDirection":"desc","otherBucket":true,"parentFormat":{"id":"terms"},"size":5},"scale":"ordinal","sourceField":"proto.keyword"},"fdcce67a-0b5e-4959-a90d-5aaf923f440c":{"dataType":"number","isBucketed":false,"label":"Count of records","operationType":"count","params":{"emptyAsNull":true},"scale":"ratio","sourceField":"___records___"}},"incompleteColumns":{}}}}},"filters":[],"query":{"language":"kuery","query":""},"visualization":{"layers":[{"categoryDisplay":"default","groups":["c57f7505-5350-42ca-960b-01935d4a1b2f"],"layerId":"513e4cd3-c4f3-4337-a7eb-fb2fb6837fbd","layerType":"data","legendDisplay":"default","metric":"fdcce67a-0b5e-4959-a90d-5aaf923f440c","nestedLegend":false,"numberDisplay":"percent"}],"shape":"donut"}},"title":"Protocol","visualizationType":"lnsPie"},"coreMigrationVersion":"8.4.1","id":"68a65bd0-36ef-11ed-9843-4d8cf291ba88","migrationVersion":{"lens":"8.3.0"},"references":[{"id":"0bc2af01-c4ee-409b-b44f-9c547251aac7","name":"indexpattern-datasource-layer-513e4cd3-c4f3-4337-a7eb-fb2fb6837fbd","type":"index-pattern"}],"type":"lens","updated_at":"2022-09-18T09:03:46.325Z","version":"WzEzNiwxXQ=="}
{"attributes":{"description":"","state":{"datasourceStates":{"indexpattern":{"layers":{"18885970-c073-4278-8475-3ebae0ca2c18":{"columnOrder":["3f36ead6-aebe-41cf-9ba4-114753c4ff22","9a7c1912-17b4-4ee1-a59d-faa9c7a1bcd3"],"columns":{"3f36ead6-aebe-41cf-9ba4-114753c4ff22":{"dataType":"string","isBucketed":true,"label":"Top 50 values of cliIP.keyword","operationType":"terms","params":{"missingBucket":false,"orderBy":{"columnId":"9a7c1912-17b4-4ee1-a59d-faa9c7a1bcd3","type":"column"},"orderDirection":"desc","otherBucket":true,"parentFormat":{"id":"terms"},"size":50},"scale":"ordinal","sourceField":"cliIP.keyword"},"9a7c1912-17b4-4ee1-a59d-faa9c7a1bcd3":{"dataType":"number","isBucketed":false,"label":"Count of records","operationType":"count","params":{"emptyAsNull":true},"scale":"ratio","sourceField":"___records___"}},"incompleteColumns":{}}}}},"filters":[],"query":{"language":"kuery","query":""},"visualization":{"columns":[{"columnId":"3f36ead6-aebe-41cf-9ba4-114753c4ff22","width":372.5},{"columnId":"9a7c1912-17b4-4ee1-a59d-faa9c7a1bcd3","width":179.5}],"layerId":"18885970-c073-4278-8475-3ebae0ca2c18","layerType":"data"}},"title":"Top Client IP","visualizationType":"lnsDatatable"},"coreMigrationVersion":"8.4.1","id":"7c329700-36ee-11ed-9843-4d8cf291ba88","migrationVersion":{"lens":"8.3.0"},"references":[{"id":"0bc2af01-c4ee-409b-b44f-9c547251aac7","name":"indexpattern-datasource-layer-18885970-c073-4278-8475-3ebae0ca2c18","type":"index-pattern"}],"type":"lens","updated_at":"2022-09-18T09:29:11.241Z","version":"WzEyNjgsMV0="}
{"attributes":{"description":"","state":{"datasourceStates":{"indexpattern":{"layers":{"039cec7c-ac90-45b0-a31b-f2cbce0aeb3d":{"columnOrder":["e6feff6d-f7d2-4776-91f4-91d98a4e88d2","8638b3a0-723c-4eb2-a2cb-94486464072c"],"columns":{"8638b3a0-723c-4eb2-a2cb-94486464072c":{"dataType":"number","filter":{"language":"kuery","query":"not errorCode.keyword : \"-\" "},"isBucketed":false,"label":"Count of records","operationType":"count","params":{"emptyAsNull":true},"scale":"ratio","sourceField":"___records___"},"e6feff6d-f7d2-4776-91f4-91d98a4e88d2":{"dataType":"string","isBucketed":true,"label":"Top 5 values of errorCode.keyword","operationType":"terms","params":{"missingBucket":false,"orderBy":{"columnId":"8638b3a0-723c-4eb2-a2cb-94486464072c","type":"column"},"orderDirection":"desc","otherBucket":true,"parentFormat":{"id":"terms"},"size":5},"scale":"ordinal","sourceField":"errorCode.keyword"}},"incompleteColumns":{}}}}},"filters":[],"query":{"language":"kuery","query":""},"visualization":{"axisTitlesVisibilitySettings":{"x":true,"yLeft":true,"yRight":true},"fittingFunction":"None","gridlinesVisibilitySettings":{"x":true,"yLeft":true,"yRight":true},"labelsOrientation":{"x":0,"yLeft":0,"yRight":0},"layers":[{"accessors":["8638b3a0-723c-4eb2-a2cb-94486464072c"],"layerId":"039cec7c-ac90-45b0-a31b-f2cbce0aeb3d","layerType":"data","position":"top","seriesType":"bar_stacked","showGridlines":false,"xAccessor":"e6feff6d-f7d2-4776-91f4-91d98a4e88d2"}],"legend":{"isVisible":true,"position":"right"},"preferredSeriesType":"bar_stacked","tickLabelsVisibilitySettings":{"x":true,"yLeft":true,"yRight":true},"valueLabels":"hide"}},"title":"Error Code","visualizationType":"lnsXY"},"coreMigrationVersion":"8.4.1","id":"f80e0c60-36ee-11ed-9843-4d8cf291ba88","migrationVersion":{"lens":"8.3.0"},"references":[{"id":"0bc2af01-c4ee-409b-b44f-9c547251aac7","name":"indexpattern-datasource-layer-039cec7c-ac90-45b0-a31b-f2cbce0aeb3d","type":"index-pattern"}],"type":"lens","updated_at":"2022-09-18T09:03:46.325Z","version":"WzEzOSwxXQ=="}
{"attributes":{"description":"","state":{"datasourceStates":{"indexpattern":{"layers":{"81d78662-b298-4e2f-bc7e-6d80f2758f0c":{"columnOrder":["e950d981-f1bb-4500-b019-394574f637ec","da2bc953-e93e-43ac-a1a7-864c83347a8b"],"columns":{"da2bc953-e93e-43ac-a1a7-864c83347a8b":{"dataType":"number","isBucketed":false,"label":"Count of records","operationType":"count","params":{"emptyAsNull":true},"scale":"ratio","sourceField":"___records___"},"e950d981-f1bb-4500-b019-394574f637ec":{"dataType":"string","isBucketed":true,"label":"Top 50 values of reqPath.keyword","operationType":"terms","params":{"exclude":["-"],"excludeIsRegex":false,"missingBucket":false,"orderBy":{"columnId":"da2bc953-e93e-43ac-a1a7-864c83347a8b","type":"column"},"orderDirection":"desc","otherBucket":true,"parentFormat":{"id":"terms"},"size":50},"scale":"ordinal","sourceField":"reqPath.keyword"}},"incompleteColumns":{}}}}},"filters":[],"query":{"language":"kuery","query":""},"visualization":{"columns":[{"columnId":"e950d981-f1bb-4500-b019-394574f637ec","width":1000.5},{"columnId":"da2bc953-e93e-43ac-a1a7-864c83347a8b","width":144.5}],"layerId":"81d78662-b298-4e2f-bc7e-6d80f2758f0c","layerType":"data"}},"title":"Request Path","visualizationType":"lnsDatatable"},"coreMigrationVersion":"8.4.1","id":"41c0ee40-36ef-11ed-9843-4d8cf291ba88","migrationVersion":{"lens":"8.3.0"},"references":[{"id":"0bc2af01-c4ee-409b-b44f-9c547251aac7","name":"indexpattern-datasource-layer-81d78662-b298-4e2f-bc7e-6d80f2758f0c","type":"index-pattern"}],"type":"lens","updated_at":"2022-09-18T09:45:49.695Z","version":"WzE5MjIsMV0="}
{"attributes":{"state":{"datasourceStates":{"indexpattern":{"layers":{"7f642d1c-032b-427e-9133-6c9762f067ae":{"columnOrder":["331b1367-2009-4fd5-b658-4d1024edaed7","a7df794f-2d92-4d0b-8e0e-f032ef1be387"],"columns":{"331b1367-2009-4fd5-b658-4d1024edaed7":{"dataType":"string","isBucketed":true,"label":"Top 50 values of reqPath.keyword","operationType":"terms","params":{"missingBucket":false,"orderBy":{"columnId":"a7df794f-2d92-4d0b-8e0e-f032ef1be387","type":"column"},"orderDirection":"desc","otherBucket":true,"parentFormat":{"id":"terms"},"size":50},"scale":"ordinal","sourceField":"reqPath.keyword"},"a7df794f-2d92-4d0b-8e0e-f032ef1be387":{"dataType":"number","isBucketed":false,"label":"Sum of bytes","operationType":"sum","params":{"emptyAsNull":true},"scale":"ratio","sourceField":"bytes"}},"incompleteColumns":{}}}}},"filters":[],"query":{"language":"kuery","query":""},"visualization":{"layers":[{"categoryDisplay":"default","groups":["331b1367-2009-4fd5-b658-4d1024edaed7"],"layerId":"7f642d1c-032b-427e-9133-6c9762f067ae","layerType":"data","legendDisplay":"default","metric":"a7df794f-2d92-4d0b-8e0e-f032ef1be387","nestedLegend":false,"numberDisplay":"percent"}],"shape":"treemap"}},"title":"Content Bytes Treemap","visualizationType":"lnsPie"},"coreMigrationVersion":"8.4.1","id":"6a6a81c0-3736-11ed-bb70-af9818efec87","migrationVersion":{"lens":"8.3.0"},"references":[{"id":"0bc2af01-c4ee-409b-b44f-9c547251aac7","name":"indexpattern-datasource-layer-7f642d1c-032b-427e-9133-6c9762f067ae","type":"index-pattern"}],"type":"lens","updated_at":"2022-09-18T09:43:57.153Z","version":"WzE4NTMsMV0="}
{"attributes":{"description":"","state":{"datasourceStates":{"indexpattern":{"layers":{"9d0188cc-67fd-4679-8acf-3d33ee1e6621":{"columnOrder":["09c328aa-7354-4319-99f3-af75509131c4","4fc3b6dd-bcde-48f4-904e-2df93a3fc094"],"columns":{"09c328aa-7354-4319-99f3-af75509131c4":{"dataType":"string","isBucketed":true,"label":"Top 50 values of UA.keyword","operationType":"terms","params":{"missingBucket":false,"orderBy":{"columnId":"4fc3b6dd-bcde-48f4-904e-2df93a3fc094","type":"column"},"orderDirection":"desc","otherBucket":true,"parentFormat":{"id":"terms"},"size":50},"scale":"ordinal","sourceField":"UA.keyword"},"4fc3b6dd-bcde-48f4-904e-2df93a3fc094":{"dataType":"number","isBucketed":false,"label":"Count of records","operationType":"count","params":{"emptyAsNull":true},"scale":"ratio","sourceField":"___records___"}},"incompleteColumns":{}}}}},"filters":[],"query":{"language":"kuery","query":""},"visualization":{"columns":[{"columnId":"09c328aa-7354-4319-99f3-af75509131c4","width":880.5},{"columnId":"4fc3b6dd-bcde-48f4-904e-2df93a3fc094","width":144.5}],"layerId":"9d0188cc-67fd-4679-8acf-3d33ee1e6621","layerType":"data"}},"title":"User Agent","visualizationType":"lnsDatatable"},"coreMigrationVersion":"8.4.1","id":"944a14c0-36ef-11ed-9843-4d8cf291ba88","migrationVersion":{"lens":"8.3.0"},"references":[{"id":"0bc2af01-c4ee-409b-b44f-9c547251aac7","name":"indexpattern-datasource-layer-9d0188cc-67fd-4679-8acf-3d33ee1e6621","type":"index-pattern"}],"type":"lens","updated_at":"2022-09-18T09:29:47.671Z","version":"WzEyOTYsMV0="}
{"attributes":{"description":"","state":{"datasourceStates":{"indexpattern":{"layers":{"360b3ebf-ef62-4abc-8736-48e8becadb9a":{"columnOrder":["73f46dab-177b-4734-91b2-153b945202d6","0e84be89-a0dd-47dc-b986-23930585b1a7"],"columns":{"0e84be89-a0dd-47dc-b986-23930585b1a7":{"dataType":"number","isBucketed":false,"label":"Count of records","operationType":"count","params":{"emptyAsNull":true},"scale":"ratio","sourceField":"___records___"},"73f46dab-177b-4734-91b2-153b945202d6":{"dataType":"string","isBucketed":true,"label":"Top 50 values of referer.keyword","operationType":"terms","params":{"missingBucket":false,"orderBy":{"columnId":"0e84be89-a0dd-47dc-b986-23930585b1a7","type":"column"},"orderDirection":"desc","otherBucket":true,"parentFormat":{"id":"terms"},"size":50},"scale":"ordinal","sourceField":"referer.keyword"}},"incompleteColumns":{}}}}},"filters":[],"query":{"language":"kuery","query":""},"visualization":{"columns":[{"columnId":"73f46dab-177b-4734-91b2-153b945202d6","width":756.5},{"columnId":"0e84be89-a0dd-47dc-b986-23930585b1a7","width":164.5}],"layerId":"360b3ebf-ef62-4abc-8736-48e8becadb9a","layerType":"data"}},"title":"Referer","visualizationType":"lnsDatatable"},"coreMigrationVersion":"8.4.1","id":"16b15f00-36ef-11ed-9843-4d8cf291ba88","migrationVersion":{"lens":"8.3.0"},"references":[{"id":"0bc2af01-c4ee-409b-b44f-9c547251aac7","name":"indexpattern-datasource-layer-360b3ebf-ef62-4abc-8736-48e8becadb9a","type":"index-pattern"}],"type":"lens","updated_at":"2022-09-18T09:30:22.988Z","version":"WzEzODMsMV0="}
{"attributes":{"columns":[],"description":"","grid":{},"hideChart":false,"isTextBasedQuery":false,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"},"sort":[["reqTimeSec","desc"]],"title":"Raw Logs","viewMode":"documents"},"coreMigrationVersion":"8.4.1","id":"6d4904b0-36f6-11ed-9843-4d8cf291ba88","migrationVersion":{"search":"8.0.0"},"references":[{"id":"0bc2af01-c4ee-409b-b44f-9c547251aac7","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"}],"type":"search","updated_at":"2022-09-18T09:03:46.325Z","version":"WzE0MiwxXQ=="}
{"attributes":{"description":"","hits":0,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[]}"},"optionsJSON":"{\"useMargins\":true,\"syncColors\":true,\"syncTooltips\":false,\"hidePanelTitles\":false}","panelsJSON":"[{\"version\":\"8.4.1\",\"type\":\"lens\",\"gridData\":{\"x\":0,\"y\":0,\"w\":22,\"h\":12,\"i\":\"cb67c0f0-4769-4ea1-9ebf-d84cb17e5dbb\"},\"panelIndex\":\"cb67c0f0-4769-4ea1-9ebf-d84cb17e5dbb\",\"embeddableConfig\":{\"enhancements\":{}},\"panelRefName\":\"panel_cb67c0f0-4769-4ea1-9ebf-d84cb17e5dbb\"},{\"version\":\"8.4.1\",\"type\":\"lens\",\"gridData\":{\"x\":22,\"y\":0,\"w\":17,\"h\":12,\"i\":\"7549e757-e51e-417b-a9b4-5a28e6cfa700\"},\"panelIndex\":\"7549e757-e51e-417b-a9b4-5a28e6cfa700\",\"embeddableConfig\":{\"enhancements\":{}},\"panelRefName\":\"panel_7549e757-e51e-417b-a9b4-5a28e6cfa700\"},{\"version\":\"8.4.1\",\"type\":\"lens\",\"gridData\":{\"x\":39,\"y\":0,\"w\":9,\"h\":12,\"i\":\"50ae7b0c-9969-4084-8e10-d88111d272e7\"},\"panelIndex\":\"50ae7b0c-9969-4084-8e10-d88111d272e7\",\"embeddableConfig\":{\"enhancements\":{}},\"panelRefName\":\"panel_50ae7b0c-9969-4084-8e10-d88111d272e7\"},{\"version\":\"8.4.1\",\"type\":\"lens\",\"gridData\":{\"x\":0,\"y\":12,\"w\":22,\"h\":24,\"i\":\"363db6ea-62f3-487a-8a4f-09d71d696d70\"},\"panelIndex\":\"363db6ea-62f3-487a-8a4f-09d71d696d70\",\"embeddableConfig\":{\"enhancements\":{}},\"panelRefName\":\"panel_363db6ea-62f3-487a-8a4f-09d71d696d70\"},{\"version\":\"8.4.1\",\"type\":\"lens\",\"gridData\":{\"x\":22,\"y\":12,\"w\":10,\"h\":9,\"i\":\"7f253620-01f6-4336-9a6b-4975b9efccd7\"},\"panelIndex\":\"7f253620-01f6-4336-9a6b-4975b9efccd7\",\"embeddableConfig\":{\"enhancements\":{}},\"panelRefName\":\"panel_7f253620-01f6-4336-9a6b-4975b9efccd7\"},{\"version\":\"8.4.1\",\"type\":\"lens\",\"gridData\":{\"x\":32,\"y\":12,\"w\":8,\"h\":9,\"i\":\"423819e0-f06f-4e3c-b95d-ee7094f79379\"},\"panelIndex\":\"423819e0-f06f-4e3c-b95d-ee7094f79379\",\"embeddableConfig\":{\"enhancements\":{}},\"panelRefName\":\"panel_423819e0-f06f-4e3c-b95d-ee7094f79379\"},{\"version\":\"8.4.1\",\"type\":\"lens\",\"gridData\":{\"x\":40,\"y\":12,\"w\":8,\"h\":9,\"i\":\"9d87d30b-3e60-4b8b-92a2-7e6b708a53f7\"},\"panelIndex\":\"9d87d30b-3e60-4b8b-92a2-7e6b708a53f7\",\"embeddableConfig\":{\"enhancements\":{}},\"panelRefName\":\"panel_9d87d30b-3e60-4b8b-92a2-7e6b708a53f7\"},{\"version\":\"8.4.1\",\"type\":\"lens\",\"gridData\":{\"x\":22,\"y\":21,\"w\":14,\"h\":15,\"i\":\"14dec277-6071-4d50-a1be-344fd0efddd0\"},\"panelIndex\":\"14dec277-6071-4d50-a1be-344fd0efddd0\",\"embeddableConfig\":{\"enhancements\":{}},\"panelRefName\":\"panel_14dec277-6071-4d50-a1be-344fd0efddd0\"},{\"version\":\"8.4.1\",\"type\":\"lens\",\"gridData\":{\"x\":36,\"y\":21,\"w\":12,\"h\":15,\"i\":\"1f1514c5-7a47-4e92-b7a7-8696df11eb4f\"},\"panelIndex\":\"1f1514c5-7a47-4e92-b7a7-8696df11eb4f\",\"embeddableConfig\":{\"enhancements\":{}},\"panelRefName\":\"panel_1f1514c5-7a47-4e92-b7a7-8696df11eb4f\"},{\"version\":\"8.4.1\",\"type\":\"lens\",\"gridData\":{\"x\":0,\"y\":36,\"w\":29,\"h\":15,\"i\":\"13db54dd-8000-4ebf-80a9-217f07fb1499\"},\"panelIndex\":\"13db54dd-8000-4ebf-80a9-217f07fb1499\",\"embeddableConfig\":{\"enhancements\":{}},\"panelRefName\":\"panel_13db54dd-8000-4ebf-80a9-217f07fb1499\"},{\"version\":\"8.4.1\",\"type\":\"lens\",\"gridData\":{\"x\":29,\"y\":36,\"w\":19,\"h\":15,\"i\":\"4f71958f-d62c-4d35-b803-ac29af94efed\"},\"panelIndex\":\"4f71958f-d62c-4d35-b803-ac29af94efed\",\"embeddableConfig\":{\"enhancements\":{}},\"panelRefName\":\"panel_4f71958f-d62c-4d35-b803-ac29af94efed\"},{\"version\":\"8.4.1\",\"type\":\"lens\",\"gridData\":{\"x\":0,\"y\":51,\"w\":25,\"h\":17,\"i\":\"dda66d32-4ed3-459a-a58d-6d90ac941148\"},\"panelIndex\":\"dda66d32-4ed3-459a-a58d-6d90ac941148\",\"embeddableConfig\":{\"enhancements\":{}},\"panelRefName\":\"panel_dda66d32-4ed3-459a-a58d-6d90ac941148\"},{\"version\":\"8.4.1\",\"type\":\"lens\",\"gridData\":{\"x\":25,\"y\":51,\"w\":23,\"h\":17,\"i\":\"08eba552-d212-4b88-8e31-613ec0ab5ae3\"},\"panelIndex\":\"08eba552-d212-4b88-8e31-613ec0ab5ae3\",\"embeddableConfig\":{\"enhancements\":{}},\"panelRefName\":\"panel_08eba552-d212-4b88-8e31-613ec0ab5ae3\"},{\"version\":\"8.4.1\",\"type\":\"search\",\"gridData\":{\"x\":0,\"y\":68,\"w\":48,\"h\":44,\"i\":\"278ec7fb-8b0a-4612-abce-6d55615eae1f\"},\"panelIndex\":\"278ec7fb-8b0a-4612-abce-6d55615eae1f\",\"embeddableConfig\":{\"enhancements\":{}},\"panelRefName\":\"panel_278ec7fb-8b0a-4612-abce-6d55615eae1f\"}]","refreshInterval":{"pause":false,"value":30000},"timeFrom":"now-1h","timeRestore":true,"timeTo":"now","title":"Akamai","version":1},"coreMigrationVersion":"8.4.1","id":"5cf69490-36f3-11ed-9843-4d8cf291ba88","migrationVersion":{"dashboard":"8.4.0"},"references":[{"id":"21d7ed80-36f5-11ed-9843-4d8cf291ba88","name":"cb67c0f0-4769-4ea1-9ebf-d84cb17e5dbb:panel_cb67c0f0-4769-4ea1-9ebf-d84cb17e5dbb","type":"lens"},{"id":"a3372db0-36e0-11ed-9843-4d8cf291ba88","name":"7549e757-e51e-417b-a9b4-5a28e6cfa700:panel_7549e757-e51e-417b-a9b4-5a28e6cfa700","type":"lens"},{"id":"48200dd0-36ee-11ed-9843-4d8cf291ba88","name":"50ae7b0c-9969-4084-8e10-d88111d272e7:panel_50ae7b0c-9969-4084-8e10-d88111d272e7","type":"lens"},{"id":"cfd91230-36df-11ed-9843-4d8cf291ba88","name":"363db6ea-62f3-487a-8a4f-09d71d696d70:panel_363db6ea-62f3-487a-8a4f-09d71d696d70","type":"lens"},{"id":"7e7c1c60-36ef-11ed-9843-4d8cf291ba88","name":"7f253620-01f6-4336-9a6b-4975b9efccd7:panel_7f253620-01f6-4336-9a6b-4975b9efccd7","type":"lens"},{"id":"54b316e0-36ef-11ed-9843-4d8cf291ba88","name":"423819e0-f06f-4e3c-b95d-ee7094f79379:panel_423819e0-f06f-4e3c-b95d-ee7094f79379","type":"lens"},{"id":"68a65bd0-36ef-11ed-9843-4d8cf291ba88","name":"9d87d30b-3e60-4b8b-92a2-7e6b708a53f7:panel_9d87d30b-3e60-4b8b-92a2-7e6b708a53f7","type":"lens"},{"id":"7c329700-36ee-11ed-9843-4d8cf291ba88","name":"14dec277-6071-4d50-a1be-344fd0efddd0:panel_14dec277-6071-4d50-a1be-344fd0efddd0","type":"lens"},{"id":"f80e0c60-36ee-11ed-9843-4d8cf291ba88","name":"1f1514c5-7a47-4e92-b7a7-8696df11eb4f:panel_1f1514c5-7a47-4e92-b7a7-8696df11eb4f","type":"lens"},{"id":"41c0ee40-36ef-11ed-9843-4d8cf291ba88","name":"13db54dd-8000-4ebf-80a9-217f07fb1499:panel_13db54dd-8000-4ebf-80a9-217f07fb1499","type":"lens"},{"id":"6a6a81c0-3736-11ed-bb70-af9818efec87","name":"4f71958f-d62c-4d35-b803-ac29af94efed:panel_4f71958f-d62c-4d35-b803-ac29af94efed","type":"lens"},{"id":"944a14c0-36ef-11ed-9843-4d8cf291ba88","name":"dda66d32-4ed3-459a-a58d-6d90ac941148:panel_dda66d32-4ed3-459a-a58d-6d90ac941148","type":"lens"},{"id":"16b15f00-36ef-11ed-9843-4d8cf291ba88","name":"08eba552-d212-4b88-8e31-613ec0ab5ae3:panel_08eba552-d212-4b88-8e31-613ec0ab5ae3","type":"lens"},{"id":"6d4904b0-36f6-11ed-9843-4d8cf291ba88","name":"278ec7fb-8b0a-4612-abce-6d55615eae1f:panel_278ec7fb-8b0a-4612-abce-6d55615eae1f","type":"search"}],"type":"dashboard","updated_at":"2022-09-20T04:54:16.099Z","version":"WzI1OTcsMV0="}
{"attributes":{"description":"","state":{"datasourceStates":{"indexpattern":{"layers":{"392e5ac4-9305-47fe-a687-f5ad7ce68118":{"columnOrder":["9b4e7702-e299-44b6-b357-6bd26e8a05b7","33d3eded-ab7f-4092-9c2e-43fd197f8a5c"],"columns":{"33d3eded-ab7f-4092-9c2e-43fd197f8a5c":{"dataType":"number","isBucketed":false,"label":"Count of records","operationType":"count","params":{"emptyAsNull":true},"scale":"ratio","sourceField":"___records___"},"9b4e7702-e299-44b6-b357-6bd26e8a05b7":{"dataType":"string","isBucketed":true,"label":"Top 300 values of country.keyword","operationType":"terms","params":{"missingBucket":false,"orderBy":{"columnId":"33d3eded-ab7f-4092-9c2e-43fd197f8a5c","type":"column"},"orderDirection":"desc","otherBucket":true,"parentFormat":{"id":"terms"},"size":300},"scale":"ordinal","sourceField":"country.keyword"}},"incompleteColumns":{}}}}},"filters":[],"query":{"language":"kuery","query":""},"visualization":{"columns":[{"columnId":"9b4e7702-e299-44b6-b357-6bd26e8a05b7","width":284.5},{"columnId":"33d3eded-ab7f-4092-9c2e-43fd197f8a5c","width":177.5}],"layerId":"392e5ac4-9305-47fe-a687-f5ad7ce68118","layerType":"data"}},"title":"Hits by Country/Region","visualizationType":"lnsDatatable"},"coreMigrationVersion":"8.4.1","id":"a223b980-36ee-11ed-9843-4d8cf291ba88","migrationVersion":{"lens":"8.3.0"},"references":[{"id":"0bc2af01-c4ee-409b-b44f-9c547251aac7","name":"indexpattern-datasource-layer-392e5ac4-9305-47fe-a687-f5ad7ce68118","type":"index-pattern"}],"type":"lens","updated_at":"2022-09-18T09:29:30.955Z","version":"WzEyODIsMV0="}
{"excludedObjects":[],"excludedObjectsCount":0,"exportedCount":17,"missingRefCount":0,"missingReferences":[]}
EOF

until $(curl --output /dev/null --silent --head --fail http://localhost:5601/); do
    printf '.'
    sleep 5
done
sleep 10

curl --cacert /etc/elasticsearch/certs/http_ca.crt -u elastic:$ELASTIC_ADMIN_PASSWORD -X POST "http://localhost:5601/api/saved_objects/_import" -H 'kbn-xsrf: reporting' --form file=@/tmp/kibana.ndjson

# Change the password for 'elastic' user
curl --cacert /etc/elasticsearch/certs/http_ca.crt -u elastic:$ELASTIC_ADMIN_PASSWORD -X POST "http://localhost:9200/_security/user/elastic/_password" -H 'Content-Type: application/json' -d "{ \"password\" : \"$ELASTICSEARCH_PASSWORD\" }"

wall "StackScripts is finished. Please check /var/log/stackscript.log"
